{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import { inflateRaw } from \"pako\";\nimport { GameSetting, Player, Replay } from \"./dataStructures\";\n\nconst englishRegex: RegExp = /^[A-Za-z0-9_]*$/;\nconst headerLength: number = 10;\nconst decoder = new TextDecoder('utf-16');\nlet dataView: DataView;\n/**\n * Parse the entire replay to get a Replay object.\n * @param fileArrayBuffer provide the array buffer of age3Yrec file\n * @returns return a replay with game infos\n */\nexport function parseReplay(fileArrayBuffer: ArrayBuffer): Replay {\n    const uint8Ary = inflateRaw(fileArrayBuffer.slice(headerLength));\n    dataView = new DataView(uint8Ary.buffer);\n    let dictionary = scanAllFields();\n    let gameSetting: GameSetting = {\n        allowCheats: dictionary['gameallowcheats'],\n        blockade: dictionary['gameblockade'],\n        playerCount: dictionary['gamenumplayers'],\n        difficulty: dictionary['gamedifficulty'],\n        startingAge: dictionary['gamestartingage'],\n        endingAge: dictionary['gameendingage'],\n        isTreaty: dictionary['gamestartwithtreaty'],\n        allowTradeMonopoly: dictionary['gametrademonopoly'],\n        gameType: dictionary['gametype'],\n        mapCRC: dictionary['gamefilecrc'],\n        mapName: dictionary['gamefilename'],\n        mapSet: dictionary['gamefilenameext'],\n        freeForAll: dictionary['gamefreeforall'],\n        hostTime: dictionary['gamehosttime'],\n        koth: dictionary['gamekoth'],\n        latency: dictionary['gamelatency'],\n        mapSetName: dictionary['gamemapname'],\n        mapResource: dictionary['gamemapresources'],\n        radomSeed: dictionary['gamerandomseed'],\n        gameSpeed: dictionary['gamespeed'],\n    }\n\n    let players: Player[] = [];\n    for (let i = 1; i <= gameSetting.playerCount; i++) {\n        let player: Player = {\n            aiPersonality: dictionary[`gameplayer${i}aipersonality`],\n            avatarId: dictionary[`gameplayer${i}avatarid`],\n            civId: dictionary[`gameplayer${i}civ`],\n            civIsRandom: dictionary[`gameplayer${i}civwasrandom`],\n            clan: dictionary[`gameplayer${i}clan`],\n            color: dictionary[`gameplayer${i}color`],\n            explorerName: dictionary[`gameplayer${i}explorername`],\n            explorerSkinId: dictionary[`gameplayer${i}explorerskinid`],\n            handicap: dictionary[`gameplayer${i}handicap`],\n            homecityFileName: dictionary[`gameplayer${i}hcfilename`],\n            homecityLevel: dictionary[`gameplayer${i}hclevel`],\n            homecityName: dictionary[`gameplayer${i}homecityname`],\n            slotId: dictionary[`gameplayer${i}id`],\n            playerName: dictionary[`gameplayer${i}name`]\n        }\n        players.push(player);\n    }\n\n    let replay: Replay = {\n        setting: gameSetting,\n        players: players,\n    }\n\n    return replay;\n}\n\nfunction scanAllFields(): { [k: string]: any } {\n    let dictionary: { [k: string]: any } = {};\n    let position = 0;\n    let endPosition = 20000; // the position of the fields won't exceed this number\n    let skipCount: number = 0;\n    while (position < endPosition) {\n        let word = readString(position, 1);\n        if (englishRegex.test(word)) {\n            if (skipCount >= 4) {\n                let isNextWord = true;\n                let nextWordLength: number = readInt32(position - 4);\n                let nextWord = readString(position, nextWordLength);\n                for (let char of nextWord) {\n                    if (!englishRegex.test(char)) {\n                        isNextWord = false;\n                        break;\n                    }\n                }\n                if (isNextWord) {\n                    position += nextWord.length * 2;\n                    let dataType = readInt32(position);\n                    position += 4;\n                    let data: any;\n                    switch (dataType) {\n                        case 1:\n                            data = readFloat32(position);\n                            position += 4;\n                            dictionary[nextWord] = data;\n                            break;\n                        case 2:\n                            data = readInt32(position);\n                            position += 4;\n                            dictionary[nextWord] = data;\n                            break;\n                        case 5:\n                            let bool = readBool(position);\n                            position += 1;\n                            dictionary[nextWord] = bool;\n                            break;\n                        case 9:\n                            let stringLength = readInt32(position);\n                            if (stringLength > 100) {\n                                position -= 4;\n                                // if stringLength is very long, it's most likely not a field.\n                                break;\n                            }\n                            position += 4;\n                            let string = readString(position, stringLength);\n                            position += stringLength * 2;\n                            dictionary[nextWord] = string;\n                            break;\n                    }\n                } else {\n                    position += 2;\n                }\n                skipCount = 0;\n            } else {\n                position += 2;\n            }\n        } else {\n            position += 1;\n            skipCount += 1;\n        }\n    }\n    return dictionary;\n}\n\nfunction readString(position: number, length: number): string {\n    const end = position + length * 2;\n    const string = decoder.decode(dataView.buffer.slice(position, end));\n    return string\n}\n\nfunction readInt32(position: number): number {\n    const int32 = dataView.getInt32(position, true);\n    return int32\n}\n\nfunction readFloat32(position: number): number {\n    const float32 = dataView.getFloat32(position, true)\n    return float32;\n}\n\nfunction readBool(position: number): boolean {\n    const bool = dataView.getUint8(position);\n    return Boolean(bool);\n}\n\nfunction readInt8(position: number): number {\n    const int8 = dataView.getUint8(position)\n    return int8\n}"],"mappings":"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","names":[]}